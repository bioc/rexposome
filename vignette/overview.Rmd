---
title: "rexposome overview"
author: "Carles Hernandez-Ferer and Juan R. Gonzalez"
date: "12 July 2016"
output:
  BiocStyle::html_document:
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

````{r multiplot, echo=FALSE}
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
    library(grid)
    
    # Make a list from the ... arguments and plotlist
    plots <- c(list(...), plotlist)
    
    numPlots = length(plots)
    
    # If layout is NULL, then use 'cols' to determine layout
    if (is.null(layout)) {
        # Make the panel
        # ncol: Number of columns of plots
        # nrow: Number of rows needed, calculated from # of cols
        layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
        ncol = cols, nrow = ceiling(numPlots/cols))
    }

    if (numPlots==1) {
        print(plots[[1]])
    } else {
        # Set up the page
        grid.newpage()
        pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
        # Make each plot, in the correct location
        for (i in 1:numPlots) {
            # Get the i,j matrix positions of the regions that contain this subplot
            matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
            print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                            layout.pos.col = matchidx$col))
        }
    }
}
````

# Introduction

# Pipeline

First `rexposome` needs to be loaded:

````{r library_1, eval=FALSE}
library(rexposome)
````

````{r library_2, include=FALSE}
library(rexposome)
````

## Exposome Loading

The function `read_exposome` allows to create an `ExposomeSet` from the raw files:

````{r load_data}
path <- paste0(path.package("rexposome"), .Platform$file.sep, "extdata")
description <- paste0(path, .Platform$file.sep, "exposFam.txt")
phenotype <- paste0(path, .Platform$file.sep, "phenoData.txt")
exposures <- paste0(path, .Platform$file.sep, "exposome.txt")
exp <- read_exposome(exposures, description, phenotype, sep = "\t")
````

The functions allows full flexibility to specify the the location of the exposure's names. The created `ExposomeSet` object shows all the information of the loaded exposome:

````{r show_es_1}
exp
````

Under the section _exposures description_ the number of continuous and categorical exposures are shown. The _assayData_, _phenoData_ and _featureData_ shows the content of the files we laoded with `read_exposome`.

The dataset used in this examples has the exposures already strandardized ans log-transformed. For those that needs to apply a standardization or a tranformation to the exposures of an `ExposomeSet`:

  * `standardize`: Given an `ExposomeSet` it standardizes the exposures by using mean/sd if method is `"normal"` or by using median/mad if method is `"robust"`.
  * `trans`: The exposures in an `ExposomeSet` can be transformed using this function. `trans` apples a function to the selected exposures.

The following examples ilustrates how to standardize three selected exposures in an `ExposomeSet`:

````{r std_examples}
exp_std <- standardize(exp, select = c("lcrCo_T1", "lcrNi_T1", "lcrCu_T1"))
exp_std
````

The function `standardize` warns us that only continuous variables will be strandardize. The obtained `ExposomeSet`, `exp_std``shows, under _exposures transformation_, that 3 exposures where standardized.

````{r trn_examples, warning = FALSE}
exp_trn <- trans(exp_std, fun = log, select = c("lcrCo_T1", "lcrNi_T1", "lcrCu_T1"))
exp_trn
````

The resulting `ExposomeSet` accumulates three standardized exposures and three transfoemd exposures. This is indicated when the `exp_trn` is print (under _exposures transformation_).

## Missing Data

### Missing Data

The function `plotMissings` (and `tableMissings`) allows to see the missing data in both exposures and phenotypes.

The following command draws a plot with the amoung of missing data in each exposure:

````{r missing_exposures}
plotMissings(exp, set = "exposures")
````

The purple bar shows the amoung missing data in each exposures. Ir represents the amoung data in proportion of the collected samples.

The same can be done with penotypes:

````{r missing_phenotypes}
plotMissings(exp, set = "phenotypes")
````

But in this dataset, there are no missing data in phenotypes.

### Imputation

The imputation of exposures and phenotypes is not the topic of `rexposome`. Nevertheless, it comes with a wraper of `mice` to be used with `ExposomeSet` objects:

````{r impute, eval=FALSE}
exp <- impute(exp)
exp
````

````{r missing_exposures_imp}
plotMissings(exp, set = "exposures")
````

### Restore

The changes applied to an `ExposomeSet` can be "deleted" by using the function `restore`:

````{r restore}
exp_std <- restore(exp_std)
exp_std
````

````{r, include = FALSE}
rm(exp_std, exp_trn)
````

## Exposome Description


### Description

````{r summary_exposures}
Summary(exp, set = "exposures", select = c("lBROM_T1", "ETS", "cleaning_products", "logcbPFHxS"))
````

````{r summary_phenotypes}
Summary(exp, set = "phenotypes")
````

### Families of Exposures

````{r plot_family, fig.height = 12}
plotFamily(exp, family = "all")
````

### Correlation between Exposures

````{r correlation, warning = FALSE}
exp_cr <- correlation(exp)
````

````{r plot_correlation}
plotCorrelation(exp_cr, type = "circos")
````

````{r extract_correlation}
dim(extract(exp_cr))
extract(exp_cr)[1:4, 1:4]
````

### Exposome PCA

````{r pca}
exp.p <- pca(exp)
````


````{r plotPCA}
plotPCA(exp.p, set = "all")
````

````{r mosaic_pca}
plots <- list(
    plotPCA(exp.p, set = "exposures", cmpX = 1, cmpY = 2) + ggplot2::theme(legend.position = "none"),
    plotPCA(exp.p, set = "exposures", cmpX = 1, cmpY = 3) + ggplot2::theme(legend.position = "none"),
    plotPCA(exp.p, set = "exposures", cmpX = 1, cmpY = 4) + ggplot2::theme(legend.position = "none"),
    plotPCA(exp.p, set = "exposures", cmpX = 2, cmpY = 3) + ggplot2::theme(legend.position = "none"),
    plotPCA(exp.p, set = "exposures", cmpX = 2, cmpY = 4) + ggplot2::theme(legend.position = "none"),
    plotPCA(exp.p, set = "exposures", cmpX = 2, cmpY = 5) + ggplot2::theme(legend.position = "none")
)

multiplot(plotlist = plots, cols = 3)
````


### Exposome Clustering

Clustering of samples throught the exposures is allowed using the function `clustering`. Thsi functions allows to apply any clustering-method on the exposures side.

````{r include=FALSE}
suppressMessages(library(mclust))
````

````{r clustering_mclust, eval=FALSE}
library(mclust)
c <- clustering(exp, method = Mclust, G = 2)
c
classification(c)
````

````{r clustering_flexmix, eval=FALSE}
library(flexmix)
# First we carete a function to apply flexmix to the ExposomeSet
flexmix_clust <- function(data, ...) {
    t <- as.formula(paste0(paste0(colnames(data), collapse="+"), "~1"))
    flexmix(t, data, ...)
}
# We create a function to get the classification
flexmix_clas <- function(model, ...) {
    return(clusters(model))
}

# We put it to the ExposomeClust
c <- clustering(exp, method = flexmix_clust, cmethod = flexmix_clas,
     k = 2, model = FLXMCmvnorm())
classification(c)
````
